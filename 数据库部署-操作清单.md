# ✅ 数据库部署操作清单

## 📋 部署步骤

### ✅ 步骤 1：配置环境变量（必须）

在云开发控制台配置数据库访问凭证：

**操作位置**：
- 登录：https://console.cloud.tencent.com/tcb
- 环境：`prison-museum-dev-8e6hujc6eb768b`
- 路径：**"云托管" → "服务管理" → "museum-api" → "环境变量"**

**需要添加的环境变量**：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `TCB_ENV` | `prison-museum-dev-8e6hujc6eb768b` | 云开发环境ID |
| `TCB_SECRET_ID` | `你的SecretId` | 腾讯云SecretId |
| `TCB_SECRET_KEY` | `你的SecretKey` | 腾讯云SecretKey |

**获取 SecretId 和 SecretKey**：
1. 访问：https://console.cloud.tencent.com/cam/capi
2. 如果没有密钥，点击 **"新建密钥"**
3. 复制 `SecretId` 和 `SecretKey`
4. ⚠️ **注意**：SecretKey 只在创建时显示一次，请妥善保管！

---

### ✅ 步骤 2：创建数据库集合（可选但推荐）

集合会在首次使用时自动创建，但提前创建可以配置索引：

**操作位置**：
- 路径：**"数据库" → "数据集合"**

**需要创建的集合**：

- [ ] `users` - 用户账号信息
- [ ] `admins` - 管理员账号信息
- [ ] `bookings` - 预约信息
- [ ] `halls` - 展区信息
- [ ] `feedbacks` - 用户反馈信息
- [ ] `collections` - 用户收藏信息
- [ ] `certificates` - 电子证书信息
- [ ] `visit_settings` - 参观时段设置
- [ ] `ar_checkins` - AR打卡记录

**创建方法**：
1. 点击 **"新建集合"**
2. 输入集合名称
3. 点击 **"确定"**

---

### ✅ 步骤 3：配置数据库索引（可选但推荐）

为了提高查询性能，建议配置索引：

**索引配置清单**：

#### users 集合
- [ ] `openId` - **唯一索引**

#### bookings 集合
- [ ] `userId` - 普通索引
- [ ] `bookingDate` - 普通索引
- [ ] `status` - 普通索引

#### admins 集合
- [ ] `username` - **唯一索引**

#### feedbacks 集合
- [ ] `userId` - 普通索引
- [ ] `status` - 普通索引

**配置方法**：
1. 在集合列表中点击集合名称
2. 进入 **"索引"** 标签页
3. 点击 **"创建索引"**
4. 选择字段，设置索引类型
5. 点击 **"确定"**

---

### ✅ 步骤 4：重新部署服务器（必须）

环境变量配置后，必须重新部署服务器才能生效：

**操作位置**：
- 路径：**"云托管" → "服务管理" → "museum-api"**

**操作步骤**：
1. 点击服务名称进入详情页
2. 点击 **"重新部署"** 或 **"部署新版本"**
3. 如果使用Git仓库部署，选择分支 `main`，构建目录 `服务器`
4. 点击 **"开始部署"**
5. 等待部署完成（约2-5分钟）

---

### ✅ 步骤 5：验证数据库连接

部署完成后，检查服务器日志：

**查看日志**：
- 路径：**"云托管" → "服务管理" → "museum-api" → "日志"**

**应该看到**：
```
云数据库初始化成功，环境ID: prison-museum-dev-8e6hujc6eb768b
开始初始化云数据库集合...
默认管理员账号已创建: zysfjgxy / 123456
云数据库集合初始化完成
```

**如果看到错误**：
- 检查环境变量是否正确配置
- 检查 SecretId 和 SecretKey 是否正确
- 查看错误详情进行排查

---

## 📝 配置示例

### 环境变量配置示例

```
TCB_ENV=prison-museum-dev-8e6hujc6eb768b
TCB_SECRET_ID=AKIDxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TCB_SECRET_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 数据库连接测试

部署后可以测试以下API：

1. **健康检查**：
   ```
   GET https://museum-api-xxx.sh.run.tcloudbase.com/health
   ```

2. **用户登录**（会自动创建用户）：
   ```
   POST https://museum-api-xxx.sh.run.tcloudbase.com/api/user/login
   ```

---

## ✅ 完成检查

部署完成后，请确认：

- [ ] 环境变量已配置（TCB_ENV、TCB_SECRET_ID、TCB_SECRET_KEY）
- [ ] 服务器已重新部署
- [ ] 服务器日志显示"数据库初始化成功"
- [ ] 默认管理员账号已创建（zysfjgxy / 123456）
- [ ] 可以正常访问健康检查接口

---

## 🆘 需要帮助？

如果遇到问题，请参考：
- 详细部署指南：`数据库部署指南.md`
- 快速开始指南：`服务器/数据库部署-快速开始.md`
- 数据库架构文档：`服务器/db/database-schema.md`

---

## 🎉 部署完成后

数据库部署完成后，所有数据操作都会真正保存到云数据库，包括：
- ✅ 用户账号信息
- ✅ 管理员信息
- ✅ 预约记录
- ✅ 展区信息
- ✅ 用户反馈
- ✅ 其他所有数据

现在可以正常使用系统的所有功能了！

