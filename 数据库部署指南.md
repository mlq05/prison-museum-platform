# 📊 数据库部署指南

## 📋 概述

本项目使用**腾讯云开发数据库（CloudBase Database）**作为数据存储。云开发数据库是NoSQL数据库，无需安装和配置，集合会在首次使用时自动创建。

## 🎯 部署步骤

### 第一步：配置环境变量

在云开发控制台配置数据库访问所需的环境变量：

1. 登录 [云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择环境：`prison-museum-dev-8e6hujc6eb768b`
3. 进入 **"云托管" → "服务管理" → "museum-api" → "环境变量"**
4. 添加以下环境变量：

```
TCB_ENV=prison-museum-dev-8e6hujc6eb768b
TCB_SECRET_ID=你的SecretId
TCB_SECRET_KEY=你的SecretKey
```

**获取 SecretId 和 SecretKey**：
- 登录 [腾讯云控制台](https://console.cloud.tencent.com)
- 进入 **"访问管理" → "API密钥管理"**
- 创建或查看密钥，复制 `SecretId` 和 `SecretKey`

⚠️ **安全提示**：这些密钥具有很高的权限，请妥善保管，不要泄露！

---

### 第二步：在云开发控制台创建集合（可选但推荐）

虽然集合会在首次使用时自动创建，但提前创建并配置索引可以提高性能：

1. 登录 [云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择环境：`prison-museum-dev-8e6hujc6eb768b`
3. 进入 **"数据库" → "数据集合"**

#### 需要创建的集合列表：

1. ✅ **users** - 用户账号信息
2. ✅ **admins** - 管理员账号信息
3. ✅ **bookings** - 预约信息
4. ✅ **halls** - 展区信息
5. ✅ **feedbacks** - 用户反馈信息
6. ✅ **collections** - 用户收藏信息
7. ✅ **certificates** - 电子证书信息
8. ✅ **visit_settings** - 参观时段设置
9. ✅ **ar_checkins** - AR打卡记录

**创建方法**：
- 点击 **"新建集合"**
- 输入集合名称
- 点击 **"确定"** 创建

---

### 第三步：配置数据库索引（推荐）

为了提高查询性能，建议配置以下索引：

#### 1. users 集合索引

- `openId` - **唯一索引**（用于快速查询用户）

#### 2. bookings 集合索引

- `userId` - 普通索引
- `bookingDate` - 普通索引
- `status` - 普通索引
- `bookingDate + bookingTimeSlot` - **复合索引**（用于查询时段预约）

#### 3. admins 集合索引

- `username` - **唯一索引**

#### 4. feedbacks 集合索引

- `userId` - 普通索引
- `status` - 普通索引

#### 5. collections 集合索引

- `userId + type + itemId` - **复合唯一索引**（防止重复收藏）

**配置索引方法**：
1. 在集合列表中点击集合名称
2. 进入 **"索引"** 标签页
3. 点击 **"创建索引"**
4. 选择字段，设置索引类型（唯一/普通）
5. 点击 **"确定"** 创建

---

### 第四步：初始化默认数据

系统启动时会自动创建默认管理员账号，但你也可以手动初始化：

#### 方式一：自动初始化（推荐）

服务器启动时会自动执行 `initDatabase()`，创建默认管理员：
- 用户名：`zysfjgxy`
- 密码：`123456`

#### 方式二：手动初始化

运行初始化脚本：

```bash
cd 服务器
npm run init-db
```

---

### 第五步：验证数据库连接

部署完成后，检查服务器日志，应该看到：

```
云数据库初始化成功，环境ID: prison-museum-dev-8e6hujc6eb768b
开始初始化云数据库集合...
默认管理员账号已创建: zysfjgxy / 123456
云数据库集合初始化完成
```

如果看到错误信息，检查：
1. 环境变量是否正确配置
2. SecretId 和 SecretKey 是否正确
3. 环境ID是否正确

---

## 🔧 数据库连接配置

### 环境变量说明

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `TCB_ENV` | 云开发环境ID | `prison-museum-dev-8e6hujc6eb768b` |
| `TCB_SECRET_ID` | 腾讯云SecretId | `AKIDxxxxxxxxxxxxxxxxxxxxx` |
| `TCB_SECRET_KEY` | 腾讯云SecretKey | `xxxxxxxxxxxxxxxxxxxxxxxxx` |

### 代码配置位置

数据库连接配置在 `服务器/db/database.js`：

```javascript
const envId = process.env.TCB_ENV || process.env.TENCENTCLOUD_RUNENV || 'prison-museum-dev-8e6hujc6eb768b';

app = tcb.init({
  env: envId,
  secretId: process.env.TCB_SECRET_ID,
  secretKey: process.env.TCB_SECRET_KEY,
});
```

---

## 📚 数据库集合说明

详细字段说明请参考：`服务器/db/database-schema.md`

### 集合列表

1. **users** - 用户账号信息
   - 存储用户基本信息、角色、联系方式等

2. **admins** - 管理员账号信息
   - 存储管理员用户名、密码哈希、权限等

3. **bookings** - 预约信息
   - 存储用户预约详情、状态、审核信息等

4. **halls** - 展区信息
   - 存储展区名称、描述、AR配置等

5. **feedbacks** - 用户反馈信息
   - 存储用户反馈内容、评分、审核状态等

6. **collections** - 用户收藏信息
   - 存储用户收藏的知识点、展区、模型等

7. **certificates** - 电子证书信息
   - 存储用户获得的证书信息

8. **visit_settings** - 参观时段设置
   - 存储管理员配置的参观时段和容量

9. **ar_checkins** - AR打卡记录
   - 存储用户AR打卡记录

---

## ✅ 部署检查清单

- [ ] 已在云开发控制台配置环境变量（`TCB_ENV`、`TCB_SECRET_ID`、`TCB_SECRET_KEY`）
- [ ] 已在云开发控制台创建所有必要的集合（可选）
- [ ] 已配置数据库索引（可选但推荐）
- [ ] 服务器已部署并运行
- [ ] 检查服务器日志，确认数据库初始化成功
- [ ] 测试数据库连接（可以通过API测试）

---

## 🧪 测试数据库连接

### 测试方法一：查看服务器日志

部署后查看服务器日志，应该看到数据库初始化成功的消息。

### 测试方法二：测试API接口

1. **测试用户登录**（会自动创建用户）：
   ```
   POST https://museum-api-xxx.sh.run.tcloudbase.com/api/user/login
   ```

2. **测试健康检查**：
   ```
   GET https://museum-api-xxx.sh.run.tcloudbase.com/health
   ```

---

## 🔍 故障排查

### 问题1：数据库初始化失败

**错误信息**：`云数据库初始化失败`

**解决方案**：
1. 检查环境变量 `TCB_ENV`、`TCB_SECRET_ID`、`TCB_SECRET_KEY` 是否正确配置
2. 检查 SecretId 和 SecretKey 是否有效
3. 检查环境ID是否正确

### 问题2：集合不存在错误

**错误信息**：`创建默认管理员失败（可能集合不存在）`

**解决方案**：
1. 在云开发控制台手动创建 `admins` 集合
2. 或者等待系统首次使用时自动创建

### 问题3：权限不足

**错误信息**：`Permission denied` 或 `Unauthorized`

**解决方案**：
1. 检查 SecretId 和 SecretKey 是否有数据库访问权限
2. 确认使用的是正确的环境ID

---

## 📖 相关文档

- 数据库架构文档：`服务器/db/database-schema.md`
- 数据库使用说明：`服务器/db/README.md`
- 数据库服务代码：`服务器/db/collections.js`
- 云数据库官方文档：https://docs.cloudbase.net/database/introduce.html

---

## 🎉 部署完成

部署完成后，你的数据库就可以使用了！

所有数据操作都通过 `服务器/db/collections.js` 中的服务层进行，确保数据真正保存到云数据库。

如有问题，请查看服务器日志或联系技术支持。

