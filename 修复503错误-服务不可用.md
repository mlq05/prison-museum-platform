# 🔧 修复 503 错误 - 服务不可用

## 📋 问题诊断

从错误日志可以看到：
- **错误类型**：`503 Service Temporarily Unavailable`
- **服务器响应**：Nginx 返回的 HTML 错误页面，而不是 JSON
- **影响范围**：所有 API 请求都失败（`/api/hall/list`、`/api/feedback/public` 等）

## ⚠️ 503 错误的含义

503 错误表示**后端服务暂时不可用**，可能原因：

1. **服务未启动** - 服务可能已停止
2. **服务崩溃** - Node.js 应用可能因为错误而崩溃
3. **服务正在重启** - 部署或更新后正在重启中
4. **健康检查失败** - 服务未通过就绪检查
5. **资源不足** - CPU 或内存不足导致服务无法响应

## ✅ 解决步骤

### 步骤 1：检查服务状态

1. **打开 CloudBase 控制台**：
   - 访问：https://console.cloud.tencent.com/tcb
   - 选择环境：`prison-museum-dev-8e6hujc6eb768b`

2. **进入云托管服务管理**：
   - 左侧导航：**"云托管"** → **"服务管理"**
   - 找到服务：**"museum-api"**

3. **查看服务状态**：
   - 检查服务状态是否显示为 **"运行中"** 或 **"异常"**
   - 如果是 **"异常"** 或 **"停止"**，需要启动服务

### 步骤 2：查看服务日志

1. **进入服务详情**：
   - 点击服务名称 **"museum-api"**

2. **查看日志**：
   - 点击 **"日志"** 标签
   - 查看最近的错误日志
   - **重点关注**：
     - 是否有 Node.js 启动错误
     - 是否有数据库连接错误
     - 是否有模块加载错误（如 `Cannot find module`）

### 步骤 3：检查服务实例

1. **查看实例状态**：
   - 在服务详情页面，查看 **"实例管理"** 或 **"运行实例"**
   - 检查是否有运行的实例
   - 如果实例状态是 **"异常"** 或 **"停止"**，说明服务崩溃了

2. **查看实例日志**：
   - 点击实例，查看详细日志
   - 找出崩溃的原因

### 步骤 4：重启服务

如果服务异常，尝试重启：

1. **方法 1：在控制台重启**
   - 在服务详情页面
   - 点击 **"重启"** 或 **"更新配置"** 按钮
   - 等待服务重新部署

2. **方法 2：重新部署**
   - 如果重启无效，可能需要重新部署
   - 检查代码是否有问题（特别是最近修改的文件）

### 步骤 5：检查环境变量

确保环境变量已正确配置：

1. **进入环境变量设置**：
   - 服务详情 → **"环境变量"**

2. **检查以下变量**：
   - ✅ `TCB_ENV` = `prison-museum-dev-8e6hujc6eb768b`
   - ✅ `TCB_SECRET_ID` = 你的 SecretId
   - ✅ `TCB_SECRET_KEY` = 你的 SecretKey
   - ✅ `PORT` = `80`（如果设置了）

### 步骤 6：检查代码问题

如果服务持续崩溃，检查代码：

1. **查看服务器日志中的错误**：
   - 是否有 `Cannot find module` 错误
   - 是否有数据库连接错误
   - 是否有语法错误

2. **常见问题**：
   - ❌ 缺少文件（如 `collections.js` 未提交到 Git）
   - ❌ 循环依赖导致模块加载失败
   - ❌ 数据库初始化失败
   - ❌ 端口配置错误

## 🔍 快速诊断清单

按照以下顺序检查：

- [ ] **步骤 1**：服务状态是否为"运行中"？
- [ ] **步骤 2**：查看日志，找出错误原因
- [ ] **步骤 3**：检查实例是否正常运行
- [ ] **步骤 4**：尝试重启服务
- [ ] **步骤 5**：验证环境变量配置
- [ ] **步骤 6**：检查代码是否有问题

## 💡 可能的原因（基于之前的修改）

由于我们刚刚修改了数据库代码，可能导致服务崩溃的原因：

1. **循环依赖问题**：
   - `collections.js` 和 `database.js` 的循环依赖
   - ✅ **已修复**（使用 `getCloudDb()`）

2. **模块缺失**：
   - `collections.js` 文件未提交到 Git
   - ✅ **已确认提交**

3. **数据库初始化失败**：
   - 环境变量未配置
   - ✅ **需检查**

4. **代码语法错误**：
   - 最近的修改可能引入错误
   - ✅ **需检查日志**

## 📝 下一步操作

1. **立即执行**：
   - 打开 CloudBase 控制台
   - 检查 `museum-api` 服务状态
   - 查看服务日志，找出错误原因

2. **如果服务已停止**：
   - 点击"重启"按钮
   - 等待服务重新启动（通常需要 1-2 分钟）

3. **如果服务持续崩溃**：
   - 将日志中的错误信息发送给我
   - 我会帮你分析和修复

## 🆘 需要帮助时

如果无法自行解决，请提供：
1. 服务状态截图
2. 服务日志中的错误信息
3. 实例状态截图

我会根据这些信息帮你进一步诊断和修复。

