# 🎯 最终部署方案

## 问题总结

你的环境 `test-7g8oe7lq75832d7c` 使用的是**旧版云托管**（deprecated API），不支持新的 `cloudbase run deploy` 命令。

## ✅ 解决方案：使用云开发控制台上传 ZIP 包

这是最可靠的方法，不需要命令行。

---

## 🚀 完整步骤

### 第一步：生成 ZIP 包

在 CMD 中执行：

```cmd
cd /d F:\test4\服务器
打包-修复版.bat
```

这会生成 `server.zip` 文件。

---

### 第二步：登录云开发控制台

1. 访问：https://console.cloud.tencent.com/tcb
2. 登录你的账号
3. **选择环境**：`test-7g8oe7lq75832d7c`

---

### 第三步：创建服务（如果还没有）

1. 左侧菜单 → **"云托管"**
2. 点击 **"服务管理"**
3. 如果列表为空或没有 `museum-api` 服务：
   - 点击 **"新建服务"**
   - 服务名称：`museum-api`
   - 服务描述：监狱历史文化展览馆API服务（可选）
   - 点击 **"提交"**

---

### 第四步：上传代码并部署

1. 在服务列表中，找到 `museum-api`，点击进入服务详情

2. 点击 **"新建版本"** 按钮

3. **选择上传方式**：
   - 选择 **"本地上传"**
   - 点击 **"选择文件"** 或 **"上传文件"**
   - 选择 `F:\test4\服务器\server.zip`
   - 等待上传完成

4. **配置版本信息**：
   - **版本备注**：`初始部署`（可选）
   - **监听端口**：`80`

5. **配置环境变量**：
   - 找到 **"环境变量"** 部分
   - 点击 **"添加环境变量"**
   - 添加以下变量：
     ```
     变量名: NODE_ENV
     变量值: production
     ```
   - 继续添加：
     ```
     变量名: JWT_SECRET
     变量值: 你的随机密钥（至少32位字符，例如：abc123xyz456def789ghi012jkl345mno678pqr）
     ```
   - 继续添加：
     ```
     变量名: PORT
     变量值: 80
     ```

6. **点击"部署"** 按钮

7. **等待部署完成**：
   - 构建过程通常需要 2-5 分钟
   - 可以在控制台查看实时日志
   - 显示"部署成功"后即可使用

---

### 第五步：获取服务地址

部署成功后：

1. 在服务详情页，找到 **"访问地址"** 或 **"域名"**
2. 地址格式类似：`https://museum-api-xxxxx.tcb.qcloud.la`
3. **复制并保存这个地址**

---

### 第六步：测试服务

在浏览器中访问健康检查接口：

```
https://museum-api-xxxxx.tcb.qcloud.la/health
```

应该返回 JSON：
```json
{
  "success": true,
  "message": "服务器运行正常",
  "timestamp": "2024-12-06T..."
}
```

---

## 📋 如果构建失败

### 查看构建日志

1. 在服务详情页，点击失败的版本
2. 查看 **"构建日志"** 标签页
3. 找到红色的错误信息

### 常见错误及解决

1. **ZIP 路径分隔符问题**：
   - 使用 `打包-修复版.bat` 重新打包
   - 确保使用最新版本的打包脚本

2. **npm install 失败**：
   - 检查 `package.json` 是否正确
   - 查看构建日志中的具体错误
   - 可能是依赖版本问题

3. **Dockerfile 错误**：
   - 检查 Dockerfile 是否存在
   - 检查 Dockerfile 语法是否正确

4. **端口配置错误**：
   - 确保端口设置为 `80`
   - 检查服务器代码中的端口配置

---

## 📝 部署后配置

### 更新小程序 API 地址

部署成功后，需要更新小程序配置：

1. 打开 `miniprogram/utils/api.ts`
2. 找到 `BASE_URL` 配置
3. 更新为你的服务地址：
   ```typescript
   const BASE_URL = 'https://museum-api-xxxxx.tcb.qcloud.la/api';
   ```

### 配置微信小程序域名白名单

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入 **"开发"** → **"开发管理"** → **"开发设置"**
3. 找到 **"服务器域名"**
4. 添加以下域名：
   - **request合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`
   - **uploadFile合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`
   - **downloadFile合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`

---

## 🎉 完成！

部署成功后，你的后端服务就可以：
- ✅ 提供 API 接口
- ✅ 处理预约请求
- ✅ 管理数据
- ✅ 支持小程序调用

---

## 📞 需要帮助？

如果遇到问题：
1. 查看云开发控制台的构建日志
2. 告诉我具体的错误信息
3. 我会继续帮你解决

