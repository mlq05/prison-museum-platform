# 数据库错误排查指南

## 常见错误：500 Internal Server Error

如果遇到以下错误：
- `创建预约失败，请稍后重试`
- `查询失败`
- `提交失败`

## 步骤 1：检查环境变量配置

在 CloudBase 控制台的"环境变量"设置中，确保以下变量**名称完全正确**：

```json
{
  "NODE_ENV": "production",
  "JWT_SECRET": "你的JWT密钥",
  "PORT": "80",
  "TCB_ENV": "prison-museum-dev-8e6hujc6eb768b",
  "TCB_SECRET_ID": "AKIDYEwZ3MVRE7tSEpDOPDnBLI4e6NSN8Scd",
  "TCB_SECRET_KEY": "ueBXlrpeKpBNM8MUVO5Zw88wb5RdnoeK"
}
```

### ⚠️ 常见错误

1. **变量名错误**：`TCB_SECRET KEY`（有空格）应该是 `TCB_SECRET_KEY`（下划线）
2. **变量值错误**：SecretId 和 SecretKey 必须是完整的、正确的值
3. **JSON 格式错误**：确保 JSON 格式正确，没有多余逗号

## 步骤 2：查看服务器日志

在 CloudBase 控制台 → 云托管 → 服务管理 → 日志，查看是否有以下错误：

- `❌ 数据库初始化失败`
- `数据库未初始化`
- `缺少必要的环境变量`

## 步骤 3：验证环境变量

确保：
- ✅ `TCB_ENV` 的值是：`prison-museum-dev-8e6hujc6eb768b`
- ✅ `TCB_SECRET_ID` 和 `TCB_SECRET_KEY` 都已设置且正确
- ✅ 所有变量名都使用**下划线**，不是空格

## 步骤 4：重新部署

环境变量修改后，**必须重新部署服务器**才能生效：

1. 保存环境变量
2. 在云托管控制台点击"重新部署"
3. 等待部署完成（通常 2-5 分钟）

## 步骤 5：测试数据库连接

部署完成后，检查服务器启动日志，应该看到：

```
✅ 云数据库初始化成功
   环境ID: prison-museum-dev-8e6hujc6eb768b
   SecretId: AKIDYEwZ...
```

如果看到：

```
❌ 数据库初始化失败：缺少必要的环境变量
```

说明环境变量配置有问题。

## 如果问题仍然存在

1. 检查 API 密钥是否有效（在腾讯云控制台验证）
2. 检查环境 ID 是否正确
3. 查看完整的服务器错误日志
4. 确保代码已更新到最新版本

