# 修复循环依赖问题

## 问题原因

`collections.js` 和 `database.js` 之间存在循环依赖：
- `database.js` require `collections.js`
- `collections.js` require `database.js` 的 `cloudDb`

这导致 `collections.js` 加载时 `cloudDb` 可能还是 `undefined`。

## 解决方案

在 `collections.js` 中，使用延迟获取的方式：

```javascript
// 延迟获取 cloudDb，避免循环依赖
function getCloudDb() {
  // 避免循环依赖：动态获取 database 模块
  const database = require('./database');
  return database.cloudDb;
}
```

然后在每个方法中调用 `getCloudDb()` 来获取数据库连接：

```javascript
async findByOpenId(openId) {
  const cloudDb = getCloudDb();
  if (!cloudDb) {
    throw new Error('数据库未初始化');
  }
  // ...
}
```

这样可以确保在方法执行时才获取 `cloudDb`，此时 `database.js` 已经完全初始化。

