# 🔧 修复预约权限和查询问题（完整版）

## 📋 问题分析

从日志和数据库截图发现以下问题：

### 问题 1：用户无法查看自己的预约（403 错误）
- **原因**：数据库中的预约记录没有 `userId` 字段（可能是旧数据）
- **症状**：`bookingUserId: undefined`，导致权限检查失败

### 问题 2：管理员无法查看所有预约记录
- **原因 1**：`keyword` 参数是字符串 `'undefined'`，导致过滤错误
- **原因 2**：状态过滤可能过滤掉了没有 `status` 字段的旧记录
- **症状**：查询到 2 条记录，但过滤后变成 0 条

## ✅ 修复方案

### 1. 修复用户权限检查（`服务器/routes/booking.js`）

**预约详情查询权限检查**：

```javascript
// 验证权限：
// 1. 管理员可以查看所有预约
// 2. 普通用户只能查看自己的预约
//    优先匹配 userId/openId，如果没有 userId 字段（旧数据），则使用 phone 匹配
const isAdmin = userRole === 'admin';

// 判断是否是预约的所有者
let isOwner = false;
if (booking.userId) {
  // 新数据：有 userId 字段，使用 userId 匹配
  isOwner = booking.userId === currentOpenId || booking.userId === currentUserId;
} else {
  // 旧数据：没有 userId 字段，使用 phone 匹配（如果当前用户有 phone 信息）
  // 注意：这是一个兼容方案，适用于旧数据
  if (booking.phone && req.user.phone) {
    isOwner = booking.phone === req.user.phone;
  }
  // 如果 booking 也没有 phone，或者用户也没有 phone，则无法匹配
}

if (!isAdmin && !isOwner) {
  // 返回 403 错误
}
```

**取消预约权限检查**：

```javascript
// 验证权限：兼容旧数据（没有 userId 的情况）
const userRole = req.user.role;
let hasPermission = false;

if (userRole === 'admin') {
  // 管理员可以取消任何预约
  hasPermission = true;
} else if (booking.userId) {
  // 新数据：有 userId 字段
  hasPermission = booking.userId === userId;
} else if (booking.phone && req.user.phone) {
  // 旧数据：使用 phone 匹配
  hasPermission = booking.phone === req.user.phone;
}
```

**改进点**：
- ✅ 兼容旧数据（没有 `userId` 字段的记录）
- ✅ 使用 `phone` 作为备用匹配字段
- ✅ 管理员始终可以访问所有预约

### 2. 修复管理员查询逻辑（`服务器/db/collections.js`）

**修复前的问题**：
- 使用 `.where({ status })` 查询，如果记录没有 `status` 字段，不会被查询到
- `keyword` 参数可能是字符串 `'undefined'`，导致过滤错误

**修复后的逻辑**：

```javascript
// 先查询所有记录（不做状态过滤，在内存中过滤）
const baseQuery = cloudDb.collection('bookings');
const tempResult = await baseQuery.get();
allBookings = tempResult.data || [];

// 状态过滤（在内存中过滤）
// 注意：如果记录没有 status 字段，status 为 undefined
// 对于 'pending' 查询，如果没有 status 字段，也视为 pending（兼容旧数据）
if (status && status !== 'all') {
  allBookings = allBookings.filter(booking => {
    const bookingStatus = booking.status || 'pending'; // 旧数据默认为 pending
    return bookingStatus === status;
  });
}

// 日期范围过滤（在内存中过滤）
if (startDate || endDate) {
  allBookings = allBookings.filter(booking => {
    if (startDate && booking.bookingDate < startDate) {
      return false;
    }
    if (endDate && booking.bookingDate > endDate) {
      return false;
    }
    return true;
  });
}

// 关键词搜索（在内存中过滤）
// 注意：keyword 可能是字符串 'undefined'，需要检查
if (keyword && keyword !== 'undefined' && keyword !== 'null') {
  allBookings = allBookings.filter(item => 
    (item.userName && item.userName.includes(keyword)) ||
    (item.phone && item.phone.includes(keyword))
  );
}
```

**改进点**：
- ✅ 先查询所有记录，然后在内存中过滤（确保不会遗漏记录）
- ✅ 旧数据（没有 `status` 字段）默认为 `'pending'`
- ✅ 正确处理 `keyword` 参数（过滤掉字符串 `'undefined'`）

### 3. 修复管理员查询参数处理（`服务器/routes/admin.js`）

```javascript
// 处理 keyword 参数：如果是字符串 'undefined'，转换为 undefined
const cleanKeyword = keyword && keyword !== 'undefined' && keyword !== 'null' ? keyword : undefined;
```

## 📝 下一步操作

### 步骤 1：提交代码修改

```bash
cd F:\test4
git add 服务器/routes/booking.js
git add 服务器/db/collections.js
git commit -m "修复：预约权限检查和管理员查询问题，兼容旧数据（无userId字段）"
git push origin main
```

### 步骤 2：等待自动部署

代码推送后，CloudBase 会自动重新部署（等待 2-5 分钟）。

### 步骤 3：测试验证

部署完成后，测试以下功能：

#### 3.1 用户端测试

1. **查看预约详情**：
   - 在小程序中查看预约详情
   - 应该能正常显示（不再出现 403 错误）
   - 即使预约记录没有 `userId` 字段，只要 `phone` 匹配，也能访问

2. **取消预约**：
   - 尝试取消自己的预约
   - 应该能正常取消（不再出现 403 错误）

#### 3.2 管理员端测试

1. **查看预约列表**：
   - 登录管理员后台
   - 进入"预约管理"
   - 应该能看到所有预约记录（包括没有 `status` 字段的旧记录）
   - 使用状态筛选（如 `pending`），应该能看到所有待审核的预约（包括旧数据）

2. **审核预约**：
   - 点击预约记录
   - 应该能正常查看详情
   - 应该能正常审核（通过/驳回）

## 🔍 如果仍然有问题

### 检查服务器日志

部署后，查看服务器日志中的以下信息：

1. **预约详情查询日志**：
   ```
   预约详情查询结果: {
     bookingId: '...',
     bookingUserId: undefined,  // 或实际值
     bookingPhone: '...',
     bookingAllKeys: [...],
     ...
   }
   权限检查失败: {
     hasUserId: false,  // 或 true
     hasPhone: true,    // 或 false
     ...
   }
   ```

2. **管理员查询日志**：
   ```
   查询到的预约总数（过滤前）: 2
   状态过滤后的预约数: 2  // 应该是 2，不是 0
   关键词过滤后的预约数: 2  // 如果没有关键词，应该不变
   分页结果: {
     total: 2,
     listLength: 2
   }
   ```

### 数据库迁移建议

如果发现大量旧记录没有 `userId` 字段，建议：

1. **方案 1：为旧记录添加 `userId`**
   - 在 CloudBase 控制台中，编辑每条预约记录
   - 根据 `phone` 查找对应的用户，添加 `userId` 字段

2. **方案 2：保持现状**
   - 代码已经兼容旧数据，可以正常工作
   - 新创建的预约会包含 `userId` 字段
   - 旧数据可以通过 `phone` 匹配

---

现在就提交代码，等待部署完成后测试！如果问题仍然存在，请查看服务器日志中的详细调试信息。

