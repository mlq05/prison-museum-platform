# 🚀 完整部署清单

## 📦 需要部署的内容

### 一、服务器代码（云托管）

**位置**：`服务器/` 目录

**打包方式**：
1. 使用打包脚本：`服务器/打包.bat`（Windows）或 `服务器/打包.sh`（Linux/Mac）
2. 或手动打包（见 `服务器/打包清单.md`）

**上传位置**：云开发控制台 → 云托管 → 服务管理

**打包文件**：`server.zip`

---

### 二、AR页面代码（静态网站托管）

**位置**：`miniprogram/ar-pages/` 目录

**包含文件**：
- `marker-ar-simple.html`
- `libs/` 目录及其所有文件

**上传位置**：云开发控制台 → 静态网站托管

**详细说明**：见 `AR页面打包指南.md`

---

## 📋 部署步骤总览

### 第一步：选择部署方式

#### ⭐ 推荐方式：使用 CloudBase CLI（不需要打包）

直接部署，避免 ZIP 路径问题。详见"第二步"的"推荐方式"。

#### 或使用 ZIP 包上传：

##### Windows:
```bash
cd 服务器
打包.bat
# 或使用修复版（如果遇到路径问题）
打包-修复版.bat
```

##### Linux/Mac:
```bash
cd 服务器
chmod +x 打包.sh
./打包.sh
```

**结果**：生成 `server.zip` 文件

⚠️ **如果构建失败，强烈推荐使用 CloudBase CLI 部署方式**

---

### 第二步：部署服务器（云托管）

#### 🎯 推荐方式：使用 CloudBase CLI（最简单，避免 ZIP 问题）

1. **安装 CloudBase CLI**：
   ```bash
   npm install -g @cloudbase/cli
   ```

2. **登录**：
   ```bash
   cloudbase login
   ```

3. **部署**（在 `服务器` 目录下）：
   ```bash
   cd 服务器
   deploy.bat
   ```
   或者手动执行：
   ```bash
   cloudbase run deploy -e prison-museum-dev-8e6hujc6eb768b -s museum-api --containerPort 80
   ```

4. **配置环境变量**（在云开发控制台）：
   ```
   NODE_ENV=production
   JWT_SECRET=你的随机密钥（至少32位）
   ```

5. **获取服务地址**：`https://museum-api-xxxxx.tcb.qcloud.la`

**优点**：
- ✅ 不需要打包 ZIP
- ✅ 自动处理路径问题
- ✅ 避免构建失败

---

#### 方式二：使用 Git 仓库部署

1. 将代码推送到 Git 仓库（GitHub/GitLab/码云）
2. 登录 [云开发控制台](https://console.cloud.tencent.com/tcb)
3. 选择环境：`prison-museum-dev`
4. 进入 **"云托管"** → **"服务管理"**
5. 点击 **"新建版本"** → **"Git 仓库"**
6. 输入仓库地址和分支
7. 设置构建目录：`服务器`（如果代码在子目录）
8. 配置环境变量并部署

---

#### 方式三：上传 ZIP 包（如果遇到问题，请使用方式一）

⚠️ **如果构建失败，推荐使用方式一（CLI部署）**

1. 使用修复版打包脚本：
   ```bash
   cd 服务器
   打包-修复版.bat
   ```

2. 登录 [云开发控制台](https://console.cloud.tencent.com/tcb)
3. 选择环境：`prison-museum-dev`
4. 进入 **"云托管"** → **"服务管理"**
5. 点击 **"新建版本"** → **"本地上传"**
6. 上传 `server.zip`
7. 配置环境变量：
   ```
   NODE_ENV=production
   JWT_SECRET=你的随机密钥（至少32位）
   ```
8. 点击 **"部署"**
9. 等待部署完成（约2-5分钟）
10. 获取服务地址：`https://museum-api-xxxxx.tcb.qcloud.la`

**如果构建失败**，请查看：
- 📄 `服务器/构建失败解决方案.md`
- 📄 `服务器/快速解决构建失败.md`

---

### 第三步：上传AR页面（静态网站托管）

1. 在云开发控制台 → **"静态网站托管"**
2. 开通服务（如果未开通）
3. 点击 **"上传文件"** 或 **"上传文件夹"**
4. 上传 `miniprogram/ar-pages/` 目录
5. 获取访问地址：`https://7072-prison-museum-dev-8e6hujc6eb768b-1390408503.tcb.qcloud.la`

---

### 第四步：更新小程序配置

#### 1. 更新API地址

**文件**：`miniprogram/utils/api.ts`

**位置**：第 14 行

**修改为**：
```typescript
const BASE_URL = 'https://museum-api-xxxxx.tcb.qcloud.la/api';
```

⚠️ 将 `museum-api-xxxxx` 替换为你的实际服务地址。

#### 2. 更新AR页面URL

**文件**：`miniprogram/pages/ar-link/ar-link.ts`

**位置**：第 117 行

**修改为**：
```typescript
const cloudHostingUrl = 'https://prison-museum-dev-xxxxx.tcloudbaseapp.com';
```

⚠️ 将 `prison-museum-dev-xxxxx` 替换为你的实际静态网站托管域名。

#### 3. 配置服务器域名白名单

在微信公众平台配置：
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入 **"开发"** → **"开发管理"** → **"开发设置"**
3. 找到 **"服务器域名"**
4. 添加以下域名：
   - **request合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`
   - **uploadFile合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`
   - **downloadFile合法域名**：`https://museum-api-xxxxx.tcb.qcloud.la`

---

## ✅ 部署检查清单

### 服务器部署
- [ ] 已打包服务器代码（server.zip）
- [ ] 已创建云托管服务
- [ ] 已上传代码并部署
- [ ] 已配置环境变量
- [ ] 已获取服务地址
- [ ] 已测试健康检查接口（`/health`）

### AR页面部署
- [ ] 已开通静态网站托管
- [ ] 已上传AR页面文件
- [ ] 已上传所有库文件
- [ ] 已获取访问地址
- [ ] 已测试AR页面访问

### 小程序配置
- [ ] 已更新API地址（`miniprogram/utils/api.ts`）
- [ ] 已更新AR页面URL（`miniprogram/pages/ar-link/ar-link.ts`）
- [ ] 已配置服务器域名白名单
- [ ] 已重新编译小程序
- [ ] 已测试小程序功能

---

## 🧪 测试部署

### 1. 测试服务器API

在浏览器中访问：
```
https://museum-api-xxxxx.tcb.qcloud.la/health
```

应该返回：
```json
{
  "success": true,
  "message": "服务器运行正常",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 2. 测试AR页面

在浏览器中访问：
```
https://prison-museum-dev-xxxxx.tcloudbaseapp.com/ar-pages/marker-ar-simple.html?hallId=1
```

应该能看到AR页面加载。

### 3. 测试小程序

1. 在微信开发者工具中编译小程序
2. 测试预约功能
3. 测试AR体验功能

---

## 📚 相关文档

- **服务器打包**：`服务器/打包清单.md`
- **服务器部署**：`服务器/快速部署指南.md`
- **构建失败解决方案**：`服务器/构建失败解决方案.md`
- **快速解决构建失败**：`服务器/快速解决构建失败.md`
- **AR页面部署**：`AR页面打包指南.md`
- **小程序配置**：`服务器/小程序配置更新说明.md`

---

## 🆘 遇到问题？

### 构建失败问题

如果上传 ZIP 后构建失败：

1. **推荐解决方案**：使用 CloudBase CLI 部署
   - 查看：`服务器/快速解决构建失败.md`
   - 不需要打包 ZIP，直接部署

2. **其他解决方案**：
   - 查看：`服务器/构建失败解决方案.md`
   - 使用 Git 仓库部署
   - 使用修复版打包脚本

### 其他问题

1. 查看相关文档
2. 检查云开发控制台日志
3. 检查文件是否正确上传
4. 检查配置是否正确

### ⚠️ 重要：为什么不能用静态网站托管？

**静态网站托管只能部署前端静态文件**（HTML、CSS、JS、图片），**不能运行后端服务器代码**。

你的项目是 **Node.js 后端 API 服务器**，必须使用**云托管**，不能使用静态网站托管。

---

## 🎉 完成！

部署完成后，你的小程序就可以：
- ✅ 使用云端API服务
- ✅ 访问AR功能
- ✅ 正常上线运行

