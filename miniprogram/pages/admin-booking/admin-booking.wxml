<!--admin-booking.wxml-->
<view class="admin-booking-page">
  <navigation-bar title="预约管理" />
  <scroll-view class="admin-booking-scroll" scroll-y="true" enable-back-to-top="true">
    <!-- 参观时段与人数设置 -->
    <view class="card">
      <view class="card-title">参观时段与人数设置</view>
      <view class="form-row">
        <text class="label">日期</text>
        <picker mode="date" value="{{settingDate}}" bindchange="onSettingDateChange">
          <view class="picker-value">{{settingDate || '请选择日期'}}</view>
        </picker>
      </view>
      <view class="slot-list">
        <block wx:if="{{visitSlots.length === 0}}">
          <view class="empty-text">正在加载时段配置...</view>
        </block>
        <block wx:for="{{visitSlots}}" wx:key="id">
          <view class="slot-item">
            <view class="slot-header">
              <view>
                <text class="slot-label">{{item.label}}</text>
                <text class="slot-time">{{item.time}}</text>
              </view>
              <switch
                checked="{{item.isActive}}"
                bindchange="onSlotActiveChange"
                data-id="{{item.id}}"
              />
            </view>
            <view class="slot-body">
              <view class="slot-input">
                <text class="sub-label">总名额</text>
                <input
                  class="number-input"
                  type="number"
                  value="{{item.capacity}}"
                  bindinput="onCapacityInput"
                  data-id="{{item.id}}"
                  placeholder="人数"
                />
              </view>
              <view class="slot-input">
                <text class="sub-label">单次上限</text>
                <input
                  class="number-input"
                  type="number"
                  value="{{item.maxPerBooking}}"
                  bindinput="onMaxPerBookingInput"
                  data-id="{{item.id}}"
                  placeholder="可不填"
                />
              </view>
            </view>
          </view>
        </block>
      </view>
      <button class="primary-btn" bindtap="onSaveVisitSettings">保存当日配置</button>
    </view>

    <!-- 预约审批列表 -->
    <view class="card">
      <view class="card-title">预约审批</view>

      <view class="filter-row">
        <picker mode="selector" range="{{statusOptions}}" range-key="label" bindchange="onStatusFilterChange">
          <view class="picker-value">
            状态：{{currentStatusLabel}}
          </view>
        </picker>
      </view>

      <view class="booking-list">
        <block wx:if="{{!loading && bookings.length === 0}}">
          <view class="empty-text">暂无预约记录</view>
        </block>

        <block wx:for="{{bookings}}" wx:key="id">
          <view class="booking-item" bindtap="onBookingTap" data-index="{{index}}">
            <view class="booking-main">
              <view class="booking-title">
                <text class="name">{{item.userName}}</text>
                <text class="status" style="color: {{item.statusColor}}">{{item.statusText}}</text>
              </view>
              <view class="booking-line">
                <text>{{item.formattedDate}}（{{item.weekday}}）</text>
              </view>
              <view class="booking-line">
                <text>时段：{{item.bookingTimeSlot}}</text>
                <text>人数：{{item.visitorCount}}人</text>
              </view>
              <view class="booking-line small">
                <text>手机：{{item.maskedPhone}}</text>
              </view>
              <view class="booking-line small" wx:if="{{item.remark}}">
                <text class="remark-label">备注：</text>
                <text class="remark-text">{{item.remark}}</text>
              </view>
            </view>

            <view class="booking-actions" wx:if="{{item.status === 'pending'}}">
              <button class="approve-btn" bindtap="onApproveBooking" data-id="{{item._id || item.id}}">通过</button>
              <button class="reject-btn" bindtap="onRejectBooking" data-id="{{item._id || item.id}}">驳回</button>
            </view>
          </view>
        </block>

        <view class="load-more" wx:if="{{loading}}">加载中...</view>
        <view class="load-more" wx:if="{{!loading && !hasMore && bookings.length > 0}}">没有更多了</view>
      </view>
    </view>

    <!-- 驳回原因弹窗 -->
    <view wx:if="{{showReviewModal}}" class="modal-mask">
      <view class="modal">
        <view class="modal-title">填写驳回原因</view>
        <textarea
          class="modal-textarea"
          placeholder="请填写驳回原因"
          value="{{rejectReason}}"
          bindinput="onRejectReasonInput"
        />
        <view class="modal-actions">
          <button class="secondary-btn" bindtap="onCloseReviewModal">取消</button>
          <button class="primary-btn" bindtap="submitReview">提交</button>
        </view>
      </view>
    </view>
  </scroll-view>
</view>

